"use strict";(self["webpackChunkhalo_admin"]=self["webpackChunkhalo_admin"]||[]).push([[994],{51823:function(t,e,a){a.d(e,{Z:function(){return m}});var i=function(){var t=this,e=t._self._c;return e("a-modal",{attrs:{destroyOnClose:"",title:"评论回复"},on:{close:t.onClose},scopedSlots:t._u([{key:"footer",fn:function(){return[e("ReactiveButton",{attrs:{errored:t.submitErrored,loading:t.submitting,erroredText:"回复失败",loadedText:"回复成功",text:"回复",type:"primary"},on:{callback:t.handleSubmitCallback,click:t.handleSubmit}})]},proxy:!0}]),model:{value:t.modalVisible,callback:function(e){t.modalVisible=e},expression:"modalVisible"}},[e("a-form-model",{ref:"replyCommentForm",attrs:{model:t.model,rules:t.rules,layout:"vertical"}},[e("a-form-model-item",{attrs:{prop:"content"}},[e("a-input",{ref:"contentInput",attrs:{autoSize:{minRows:8},type:"textarea"},model:{value:t.model.content,callback:function(e){t.$set(t.model,"content",e)},expression:"model.content"}})],1)],1)],1)},o=[],n=a(80068),s={name:"CommentReplyModal",props:{visible:{type:Boolean,default:!0},comment:{type:Object,default:null},targetId:{type:Number,default:0},target:{type:String,required:!0,validator:t=>-1!==["post","sheet","journal"].indexOf(t)}},data(){return{model:{},submitting:!1,submitErrored:!1,rules:{content:[{required:!0,message:"* 内容不能为空",trigger:["change"]}]}}},computed:{modalVisible:{get(){return this.visible},set(t){this.$emit("update:visible",t)}}},watch:{modalVisible(t){t&&this.$nextTick((()=>{this.$refs.contentInput.focus()}))}},methods:{handleSubmit(){const t=this;t.$refs.replyCommentForm.validate((async e=>{if(e)try{t.submitting=!0,t.model.postId=t.targetId,t.comment&&(t.model.parentId=t.comment.id),await n.Z.comment.create(`${t.target}s`,t.model)}catch(a){t.submitErrored=!0}finally{setTimeout((()=>{t.submitting=!1}),400)}}))},handleSubmitCallback(){this.submitErrored?this.submitErrored=!1:(this.model={},this.modalVisible=!1,this.$emit("succeed"))},onClose(){this.model={},this.modalVisible=!1}}},l=s,r=a(1001),d=(0,r.Z)(l,i,o,!1,null,null,null),m=d.exports},33196:function(t,e,a){a.d(e,{Z:function(){return y}});var i=function(){var t=this,e=t._self._c;return e("a-modal",{attrs:{afterClose:t.onClose,title:t.title,width:1024,destroyOnClose:""},scopedSlots:t._u([{key:"footer",fn:function(){return[t._t("extraFooter"),e("a-button",{attrs:{type:"primary"},on:{click:function(e){t.replyModalVisible=!0}}},[t._v("创建评论")]),e("a-button",{on:{click:function(e){t.modalVisible=!1}}},[t._v("关闭")])]},proxy:!0}],null,!0),model:{value:t.modalVisible,callback:function(e){t.modalVisible=e},expression:"modalVisible"}},[e("a-list",{attrs:{loading:t.list.loading,"item-layout":"vertical"}},t._l(t.list.data,(function(a,i){return e("TargetCommentTreeNode",{key:i,attrs:{comment:a,target:t.target,"target-id":t.targetId},on:{reload:t.handleGetComments}})})),1),e("div",{staticClass:"page-wrapper"},[e("a-pagination",{staticClass:"pagination",attrs:{current:t.pagination.page,defaultPageSize:t.pagination.size,pageSizeOptions:["10","20","50","100"],total:t.pagination.total,showLessItems:"",showSizeChanger:""},on:{change:t.handlePageChange,showSizeChange:t.handlePageSizeChange}})],1),e("CommentReplyModal",{attrs:{target:t.target,"target-id":t.targetId,visible:t.replyModalVisible},on:{"update:visible":function(e){t.replyModalVisible=e},succeed:t.handleGetComments}})],1)},o=[],n=function(){var t=this,e=t._self._c;return e("a-list-item",{staticClass:"!p-0"},[e("a-comment",{scopedSlots:t._u([{key:"author",fn:function(){return[e("a",{attrs:{href:t.comment.authorUrl,target:"_blank"}},[t.comment.isAdmin?e("a-icon",{staticStyle:{"margin-right":"3px"},attrs:{type:"user"}}):t._e(),t._v(" "+t._s(t.comment.author)+" ")],1)]},proxy:!0},{key:"avatar",fn:function(){return[e("a-avatar",{attrs:{alt:t.comment.author,src:t.comment.avatar,size:"large"}})]},proxy:!0},{key:"content",fn:function(){return[e("div",{staticClass:"comment-modal-content",domProps:{innerHTML:t._s(t.$options.filters.markdownRender(t.comment.content))}})]},proxy:!0},{key:"datetime",fn:function(){return[e("a-tooltip",{scopedSlots:t._u([{key:"title",fn:function(){return[e("span",[t._v(t._s(t._f("moment")(t.comment.createTime)))])]},proxy:!0}])},[e("span",[t._v(t._s(t._f("timeAgo")(t.comment.createTime)))])])]},proxy:!0},{key:"actions",fn:function(){return["AUDITING"===t.comment.status?e("a-dropdown",{attrs:{trigger:["click"]},scopedSlots:t._u([{key:"overlay",fn:function(){return[e("a-menu",[e("a-menu-item",{key:"1",on:{click:function(e){return t.handleChangeStatus("PUBLISHED")}}},[t._v(" 通过")]),e("a-menu-item",{key:"2",on:{click:t.handlePublishAndReply}},[t._v(" 通过并回复")])],1)]},proxy:!0}],null,!1,357119804)},[e("span",[t._v("通过")])]):"PUBLISHED"===t.comment.status?e("span",{on:{click:function(e){t.replyModalVisible=!0}}},[t._v("回复")]):"RECYCLE"===t.comment.status?e("a-popconfirm",{attrs:{title:"你确定要还原该评论？",cancelText:"取消",okText:"确定"},on:{confirm:function(e){return t.handleChangeStatus("PUBLISHED")}}},[t._v(" 还原 ")]):t._e(),"PUBLISHED"===t.comment.status||"AUDITING"===t.comment.status?e("a-popconfirm",{attrs:{title:"你确定要将该评论移到回收站？",cancelText:"取消",okText:"确定"},on:{confirm:function(e){return t.handleChangeStatus("RECYCLE")}}},[t._v(" 回收站 ")]):t._e(),e("a-popconfirm",{attrs:{title:"你确定要永久删除该评论？",cancelText:"取消",okText:"确定"},on:{confirm:t.handleDelete}},[t._v(" 删除 ")])]},proxy:!0}])},[t.comment.children?t._l(t.comment.children,(function(a,i){return e("TargetCommentTreeNode",{key:i,attrs:{comment:a,target:t.target,"target-id":t.targetId},on:{reload:function(e){return t.$emit("reload")}}})})):t._e(),e("CommentReplyModal",{attrs:{comment:t.comment,target:t.target,"target-id":t.targetId,visible:t.replyModalVisible},on:{"update:visible":function(e){t.replyModalVisible=e},succeed:function(e){return t.$emit("reload")}}})],2)],1)},s=[],l=a(80068),r=a(51823),d={name:"TargetCommentTreeNode",components:{CommentReplyModal:r.Z},props:{target:{type:String,required:!0,validator:t=>-1!==["post","sheet","journal"].indexOf(t)},targetId:{type:Number,required:!0,default:0},comment:{type:Object,required:!1,default:null}},data(){return{replyModalVisible:!1}},methods:{async handleChangeStatus(t){try{await l.Z.comment.updateStatusById(`${this.target}s`,this.comment.id,t)}catch(e){this.$log.error("Failed to change comment status",e)}finally{this.$emit("reload")}},async handlePublishAndReply(){await this.handleChangeStatus("PUBLISHED"),this.replyModalVisible=!0},async handleDelete(){try{await l.Z.comment.delete(`${this.target}s`,this.comment.id)}catch(t){this.$log.error("Failed to delete comment",t)}finally{this.$emit("reload")}}}},m=d,c=a(1001),u=(0,c.Z)(m,n,s,!1,null,null,null),p=u.exports,h={name:"TargetCommentListModal",components:{TargetCommentTreeNode:p,CommentReplyModal:r.Z},props:{visible:{type:Boolean,default:!0},title:{type:String,default:"评论"},target:{type:String,required:!0,validator:t=>-1!==["post","sheet","journal"].indexOf(t)},targetId:{type:Number,required:!0,default:0}},data(){return{list:{data:[],loading:!1,params:{page:0,size:10},total:0},replyModalVisible:!1}},computed:{modalVisible:{get(){return this.visible},set(t){this.$emit("update:visible",t)}},pagination(){return{page:this.list.params.page+1,size:this.list.params.size,total:this.list.total}}},watch:{modalVisible(t){t&&this.handleGetComments()},targetId(){this.handleGetComments()}},methods:{async handleGetComments(){try{this.list.loading=!0;const t=await l.Z.comment.listAsTreeView(`${this.target}s`,this.targetId,this.list.params);this.list.data=t.data.content,this.list.total=t.data.total}catch(t){this.$log.error("Failed to get target comments",t)}finally{this.list.loading=!1}},handlePageChange(t=1){this.list.params.page=t-1,this.handleGetComments()},handlePageSizeChange(t,e){this.list.params.page=0,this.list.params.size=e,this.handleGetComments()},onClose(){this.$emit("close")}}},f=h,g=(0,c.Z)(f,i,o,!1,null,null,null),y=g.exports},39994:function(t,e,a){a.r(e),a.d(e,{default:function(){return y}});var i=function(){var t=this,e=t._self._c;return e("page-view",[e("a-row",[e("a-col",{attrs:{span:24}},[e("a-card",{attrs:{bodyStyle:{padding:"16px"},bordered:!1}},[e("div",{staticClass:"table-page-search-wrapper"},[e("a-form",{attrs:{layout:"inline"}},[e("a-row",{attrs:{gutter:48}},[e("a-col",{attrs:{md:6,sm:24}},[e("a-form-item",{attrs:{label:"关键词："}},[e("a-input",{on:{keyup:function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")?null:t.handleQuery()}},model:{value:t.list.params.keyword,callback:function(e){t.$set(t.list.params,"keyword",e)},expression:"list.params.keyword"}})],1)],1),e("a-col",{attrs:{md:6,sm:24}},[e("a-form-item",{attrs:{label:"状态："}},[e("a-select",{attrs:{placeholder:"请选择状态"},on:{change:function(e){return t.handleQuery()}},model:{value:t.list.params.type,callback:function(e){t.$set(t.list.params,"type",e)},expression:"list.params.type"}},t._l(Object.keys(t.list.journalType),(function(a){return e("a-select-option",{key:a,attrs:{value:a}},[t._v(" "+t._s(t.list.journalType[a].text)+" ")])})),1)],1)],1),e("a-col",{attrs:{md:6,sm:24}},[e("span",{staticClass:"table-page-search-submitButtons"},[e("a-space",[e("a-button",{attrs:{type:"primary"},on:{click:function(e){return t.handleQuery()}}},[t._v("查询")]),e("a-button",{on:{click:function(e){return t.handleResetParam()}}},[t._v("重置")])],1)],1)])],1)],1)],1),e("div",{staticClass:"table-operator"},[e("a-button",{attrs:{icon:"plus",type:"primary"},on:{click:t.handleOpenPublishModal}},[t._v("写日志")])],1),e("a-divider"),e("div",{staticClass:"mt-4"},[t.list.loading||0!==t.list.data.length?e("a-list",{attrs:{dataSource:t.list.data,loading:t.list.loading,pagination:!1,itemLayout:"vertical"},scopedSlots:t._u([{key:"renderItem",fn:function(a,i){return[e("a-list-item",{key:i,scopedSlots:t._u([{key:"actions",fn:function(){return[e("a-button",{staticClass:"!p-0",attrs:{type:"link"}},[e("a-icon",{attrs:{type:"like-o"}}),t._v(" "+t._s(a.likes)+" ")],1),e("a-button",{staticClass:"!p-0",attrs:{type:"link"},on:{click:function(e){return t.handleOpenJournalCommentsDrawer(a)}}},[e("a-icon",{attrs:{type:"message"}}),t._v(" "+t._s(a.commentCount)+" ")],1),"INTIMATE"===a.type?e("a-button",{staticClass:"!p-0",staticStyle:{color:"grey"},attrs:{type:"link"},on:{click:function(e){return t.handleJournalTypeUpdate(a)}}},[e("a-icon",{attrs:{type:"lock"}})],1):e("a-button",{staticClass:"!p-0",attrs:{type:"link"},on:{click:function(e){return t.handleJournalTypeUpdate(a)}}},[e("a-icon",{attrs:{type:"unlock"}})],1)]},proxy:!0},{key:"extra",fn:function(){return[e("a-button",{staticClass:"!p-0",attrs:{type:"link"},on:{click:function(e){return t.handleOpenEditModal(a)}}},[t._v("编辑")]),e("a-divider",{attrs:{type:"vertical"}}),e("a-popconfirm",{attrs:{cancelText:"取消",okText:"确定",title:"你确定要删除这条日志？"},on:{confirm:function(e){return t.handleDelete(a.id)}}},[e("a-button",{staticClass:"!p-0",attrs:{type:"link"}},[t._v("删除")])],1)]},proxy:!0}],null,!0)},[e("a-list-item-meta",{scopedSlots:t._u([{key:"description",fn:function(){return[e("div",{staticClass:"journal-list-content",domProps:{innerHTML:t._s(a.content)}})]},proxy:!0},{key:"title",fn:function(){return[e("span",[t._v(t._s(t._f("moment")(a.createTime)))])]},proxy:!0},{key:"avatar",fn:function(){return[e("a-avatar",{attrs:{src:t.user.avatar,size:"large"}})]},proxy:!0}],null,!0)})],1)]}}])},[e("div",{staticClass:"page-wrapper"},[e("a-pagination",{staticClass:"pagination",attrs:{current:t.pagination.page,defaultPageSize:t.pagination.size,pageSizeOptions:["10","20","50","100"],total:t.pagination.total,showLessItems:"",showSizeChanger:""},on:{change:t.handlePageChange,showSizeChange:t.handlePageSizeChange}})],1)]):e("a-empty")],1)],1)],1)],1),e("div",{staticStyle:{position:"fixed",bottom:"30px",right:"30px"}},[e("a-button",{attrs:{icon:"setting",shape:"circle",size:"large",type:"primary"},on:{click:function(e){t.optionModal.visible=!0}}})],1),e("a-modal",{attrs:{afterClose:()=>t.optionModal.visible=!1,title:"页面设置"},scopedSlots:t._u([{key:"footer",fn:function(){return[e("a-button",{key:"submit",attrs:{type:"primary"},on:{click:function(e){return t.handleSaveOptions()}}},[t._v("保存")])]},proxy:!0}]),model:{value:t.optionModal.visible,callback:function(e){t.$set(t.optionModal,"visible",e)},expression:"optionModal.visible"}},[e("a-form",{attrs:{layout:"vertical"}},[e("a-form-item",{attrs:{help:"* 需要主题进行适配",label:"页面标题："}},[e("a-input",{model:{value:t.optionModal.options.journals_title,callback:function(e){t.$set(t.optionModal.options,"journals_title",e)},expression:"optionModal.options.journals_title"}})],1),e("a-form-item",{attrs:{label:"每页显示条数："}},[e("a-input-number",{staticStyle:{width:"100%"},model:{value:t.optionModal.options.journals_page_size,callback:function(e){t.$set(t.optionModal.options,"journals_page_size",e)},expression:"optionModal.options.journals_page_size"}})],1)],1)],1),e("a-modal",{attrs:{title:t.formTitle,width:820},scopedSlots:t._u([{key:"footer",fn:function(){return[e("ReactiveButton",{attrs:{errored:t.form.saveErrored,loading:t.form.saving,erroredText:"发布失败",loadedText:"发布成功",text:"发布",type:"primary"},on:{callback:t.handleSaveOrUpdateCallback,click:t.handleSaveOrUpdate}})]},proxy:!0}]),model:{value:t.form.visible,callback:function(e){t.$set(t.form,"visible",e)},expression:"form.visible"}},[e("a-form-model",{ref:"journalForm",attrs:{model:t.form.model,rules:t.form.rules,layout:"vertical"}},[e("a-form-model-item",{attrs:{prop:"sourceContent"}},[e("div",{staticStyle:{height:"520px"},attrs:{id:"editor"}},[t.form.visible?e("MarkdownEditor",{attrs:{originalContent:t.form.model.sourceContent,subfield:!1,toolbars:t.simpleEditorToolbars},on:{"update:originalContent":function(e){return t.$set(t.form.model,"sourceContent",e)},"update:original-content":function(e){return t.$set(t.form.model,"sourceContent",e)},change:t.onContentChange}}):t._e()],1)]),e("a-form-model-item",[e("a-switch",{attrs:{checkedChildren:"公开",defaultChecked:"",unCheckedChildren:"私密"},model:{value:t.form.isPublic,callback:function(e){t.$set(t.form,"isPublic",e)},expression:"form.isPublic"}})],1)],1)],1),e("TargetCommentListModal",{attrs:{"target-id":t.list.selected.id,title:`「${t.$options.filters.moment(t.list.selected.createTime)}」的评论`,visible:t.journalCommentDrawer.visible,target:"journal"},on:{"update:visible":function(e){return t.$set(t.journalCommentDrawer,"visible",e)},close:t.onJournalCommentsDrawerClose},scopedSlots:t._u([{key:"extraFooter",fn:function(){return[e("a-button",{attrs:{disabled:t.selectPreviousButtonDisabled},on:{click:t.handleSelectPrevious}},[t._v(" 上一篇")]),e("a-button",{attrs:{disabled:t.selectNextButtonDisabled},on:{click:t.handleSelectNext}},[t._v(" 下一篇")])]},proxy:!0}])})],1)},o=[],n=a(70571),s=a(33196),l=a(83428),r=a(20629),d=a(32422),m=a(16879),c=a(80068),u=a(932),p={mixins:[l.jB,l.KT],components:{MarkdownEditor:u.Z,PageView:n.B4,TargetCommentListModal:s.Z},data(){return{simpleEditorToolbars:d.o6,list:{data:[],loading:!1,total:0,params:{page:0,size:10,keyword:void 0,type:void 0},hasPrevious:!1,hasNext:!1,selected:{},journalType:{PUBLIC:{text:"公开"},INTIMATE:{text:"私密"}}},form:{model:{},rules:{sourceContent:[{required:!0,message:"* 内容不能为空",trigger:[]}]},visible:!1,saving:!1,saveErrored:!1,isPublic:!0},journalCommentDrawer:{visible:!1},optionModal:{visible:!1,options:{}}}},beforeMount(){this.handleListJournals(),this.handleListOptions()},computed:{...(0,r.Se)(["user"]),formTitle(){return this.form.model.id?"编辑":"发表"},pagination(){return{page:this.list.params.page+1,size:this.list.params.size,total:this.list.total}},selectPreviousButtonDisabled(){const t=this.list.data.findIndex((t=>t.id===this.list.selected.id));return 0===t&&!this.list.hasPrevious},selectNextButtonDisabled(){const t=this.list.data.findIndex((t=>t.id===this.list.selected.id));return t===this.list.data.length-1&&!this.list.hasNext}},methods:{...(0,r.nv)(["refreshOptionsCache"]),async handleListJournals(){try{this.list.loading=!0;const{data:t}=await c.Z.journal.list(this.list.params);if(0===t.content.length&&this.list.params.page>0)return this.list.params.page--,void await this.handleListJournals();this.list.data=t.content,this.list.total=t.total,this.list.hasPrevious=t.hasPrevious,this.list.hasNext=t.hasNext}catch(t){this.$log.error(t)}finally{this.list.loading=!1}},handleListOptions(){c.Z.option.listAsMapViewByKeys(["journals_page_size","journals_title"]).then((t=>{this.optionModal.options=t.data}))},handleQuery(){this.handlePageChange(1)},handleResetParam(){this.list.params.keyword=void 0,this.list.params.type=void 0,this.handlePageChange(1)},handleOpenPublishModal(){this.form.visible=!0,this.form.model={sourceContent:"",content:""}},handleOpenEditModal(t){this.form.model=(0,m.I8)(t),this.form.isPublic="INTIMATE"!==t.type,this.form.visible=!0},handleDelete(t){c.Z.journal.delete(t).finally((()=>{this.handleListJournals()}))},handleOpenJournalCommentsDrawer(t){this.list.selected=t,this.journalCommentDrawer.visible=!0},onContentChange({originalContent:t,renderContent:e}){this.form.model.sourceContent=t,this.form.model.content=e},handleJournalTypeUpdate(t){this.form.model=(0,m.I8)(t),this.form.model.type="PUBLIC"===t.type?"INTIMATE":"PUBLIC",c.Z.journal.update(this.form.model.id,this.form.model).catch((t=>{this.$log.error(t)})).finally((()=>{this.handleListJournals()}))},handleSaveOrUpdate(){const t=this;t.$refs.journalForm.validate((e=>{e&&(t.form.model.type=t.form.isPublic?"PUBLIC":"INTIMATE",t.form.model.keepRaw=!0,t.form.saving=!0,t.form.model.id?c.Z.journal.update(t.form.model.id,t.form.model).catch((()=>{t.form.saveErrored=!0})).finally((()=>{setTimeout((()=>{t.form.saving=!1}),400)})):c.Z.journal.create(t.form.model).catch((()=>{t.form.saveErrored=!0})).finally((()=>{setTimeout((()=>{t.form.saving=!1}),400)})))}))},handleSaveOrUpdateCallback(){this.form.saveErrored?this.form.saveErrored=!1:(this.form.isPublic=!0,this.form.visible=!1,this.handleListJournals())},handlePageChange(t=1){this.list.params.page=t-1,this.handleListJournals()},handlePageSizeChange(t,e){this.$log.debug(`Current: ${t}, PageSize: ${e}`),this.list.params.page=0,this.list.params.size=e,this.handleListJournals()},onJournalCommentsDrawerClose(){this.form.model={},this.journalCommentDrawer.visible=!1,this.handleListJournals()},handleSaveOptions(){c.Z.option.saveMapView(this.optionModal.options).then((()=>{this.$message.success("保存成功！"),this.optionModal.visible=!1})).finally((()=>{this.handleListOptions(),this.refreshOptionsCache()}))},async handleSelectPrevious(){const t=this.list.data.findIndex((t=>t.id===this.list.selected.id));t>0?this.list.selected=this.list.data[t-1]:0===t&&this.list.hasPrevious&&(this.list.params.page--,await this.handleListJournals(),this.list.selected=this.list.data[this.list.data.length-1])},async handleSelectNext(){const t=this.list.data.findIndex((t=>t.id===this.list.selected.id));t<this.list.data.length-1?this.list.selected=this.list.data[t+1]:t===this.list.data.length-1&&this.list.hasNext&&(this.list.params.page++,await this.handleListJournals(),this.list.selected=this.list.data[0])}}},h=p,f=a(1001),g=(0,f.Z)(h,i,o,!1,null,null,null),y=g.exports}}]);