(self["webpackChunkhalo_admin"]=self["webpackChunkhalo_admin"]||[]).push([[315],{54315:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return b}});var o=function(){var e=this,t=e._self._c;return t("page-view",{attrs:{"sub-title":e.sheetToStage.inProgress?"当前内容已保存，但还未发布。":"",title:e.sheetToStage.title?e.sheetToStage.title:"新页面",affix:""}},[t("template",{slot:"extra"},[t("a-space",[t("a-button",{attrs:{loading:e.previewSaving},on:{click:e.handlePreviewClick}},[e._v("预览")]),t("a-button",{attrs:{type:"primary"},on:{click:function(t){e.sheetSettingVisible=!0}}},[e._v("发布")])],1)],1),t("a-row",{attrs:{gutter:12}},[t("a-col",{attrs:{span:24}},[t("div",{staticClass:"mb-4"},[t("a-input",{attrs:{placeholder:"请输入页面标题",size:"large"},model:{value:e.sheetToStage.title,callback:function(t){e.$set(e.sheetToStage,"title",t)},expression:"sheetToStage.title"}})],1),t("div",{style:{height:e.editorHeight},attrs:{id:"editor"}},[t("MarkdownEditor",{attrs:{originalContent:e.sheetToStage.originalContent},on:{"update:originalContent":function(t){return e.$set(e.sheetToStage,"originalContent",t)},"update:original-content":function(t){return e.$set(e.sheetToStage,"originalContent",t)},change:e.onContentChange,save:function(t){return e.handleSaveDraft()}}})],1)])],1),t("SheetSettingModal",{attrs:{sheet:e.sheetToStage,savedCallback:e.onSheetSavedCallback,visible:e.sheetSettingVisible},on:{"update:visible":function(t){e.sheetSettingVisible=t},onUpdate:e.onUpdateFromSetting}})],2)},r=[],i=(a(70560),a(70571)),s=a(52173),n=a(932),l=a(83428),d=a(64203),h=a(80068),m=a(91296),c=a.n(m),u={components:{PageView:i.B4,SheetSettingModal:s.Z,MarkdownEditor:n.Z},mixins:[l.jB,l.KT,l.g3],data(){return{sheetSettingVisible:!1,sheetToStage:{},contentChanges:0,previewSaving:!1}},beforeRouteEnter(e,t,a){const o=e.query.sheetId;a((async e=>{if(o){const{data:t}=await h.Z.sheet.get(Number(o));e.sheetToStage=t}}))},destroyed:function(){window.onbeforeunload&&(window.onbeforeunload=null)},beforeRouteLeave(e,t,a){const o=this.$createElement;this.contentChanges<=1?a():this.$confirm({title:"当前页面数据未保存，确定要离开吗？",content:()=>o("div",{style:"color:red;"},["如果离开当面页面，你的数据很可能会丢失！"]),onOk(){a()},onCancel(){a(!1)}})},mounted(){window.onbeforeunload=function(e){return e=e||window.event,e&&(e.returnValue="当前页面数据未保存，确定要离开吗？"),"当前页面数据未保存，确定要离开吗？"}},beforeMount(){document.addEventListener("keydown",this.onRegisterSaveShortcut)},beforeDestroy(){document.removeEventListener("keydown",this.onRegisterSaveShortcut)},methods:{onRegisterSaveShortcut(e){!e.ctrlKey&&!e.metaKey||e.altKey||e.shiftKey||83!==e.keyCode||(e.preventDefault(),e.stopPropagation(),this.handleSaveDraft())},handleSaveDraft:c()((async function(){if(this.sheetToStage.id)try{const{data:e}=await h.Z.sheet.updateDraftById(this.sheetToStage.id,this.sheetToStage.originalContent,this.sheetToStage.content,!0);this.sheetToStage.inProgress=e.inProgress,this.handleRestoreSavedStatus(),this.$message.success({content:"内容已保存",duration:.5})}catch(e){this.$log.error("Failed to update sheet content",e)}else await this.handleCreateSheet()}),300),async handleCreateSheet(){this.sheetToStage.title||(this.sheetToStage.title=(0,d._)(new Date,"YYYY-MM-DD-HH-mm-ss"));try{this.sheetToStage.keepRaw=!0;const{data:e}=await h.Z.sheet.create(this.sheetToStage);this.sheetToStage=e,this.handleRestoreSavedStatus();const t=this.$router.history.current.path;this.$router.replace({path:t,query:{sheetId:this.sheetToStage.id}}).catch((e=>e)),this.$message.success({content:"页面已创建",duration:.5})}catch(e){this.$log.error("Failed to create sheet",e)}},async handlePreviewClick(){if(this.previewSaving=!0,this.sheetToStage.id){const{data:e}=await h.Z.sheet.updateDraftById(this.sheetToStage.id,this.sheetToStage.originalContent,this.sheetToStage.content,!0);this.sheetToStage.inProgress=e.inProgress}else await this.handleCreateSheet();await this.handleOpenPreview()},async handleOpenPreview(){try{const e=await h.Z.sheet.getPreviewLinkById(this.sheetToStage.id);window.open(e,"_blank"),this.handleRestoreSavedStatus()}catch(e){this.$log.error("Failed to get preview link",e)}finally{setTimeout((()=>{this.previewSaving=!1}),400)}},handleRestoreSavedStatus(){this.contentChanges=0},onContentChange({originalContent:e,renderContent:t}){this.contentChanges++,this.sheetToStage.originalContent=e,this.sheetToStage.content=t},onSheetSavedCallback(){this.contentChanges=0,this.$router.push({name:"SheetList",query:{activeKey:"custom"}})},onUpdateFromSetting(e){this.sheetToStage=e}}},f=u,p=a(1001),g=(0,p.Z)(f,o,r,!1,null,null,null),b=g.exports},52173:function(e,t,a){"use strict";a.d(t,{Z:function(){return b}});var o=function(){var e=this,t=e._self._c;return t("a-modal",{attrs:{afterClose:e.onClosed,bodyStyle:{padding:0},maskClosable:!1,width:680,destroyOnClose:""},scopedSlots:e._u([{key:"title",fn:function(){return[e._v(" "+e._s(e.modalTitle)+" "),e.loading?t("a-icon",{attrs:{type:"loading"}}):e._e()]},proxy:!0},{key:"footer",fn:function(){return[e._t("extraFooter"),e.draftSaveVisible?t("ReactiveButton",{attrs:{errored:e.form.draftSaveErrored,loading:e.form.draftSaving,text:(e.hasId?"转为":"保存")+"草稿",erroredText:"保存失败",loadedText:"保存成功",type:"danger"},on:{callback:function(t){return e.handleSavedCallback()},click:function(t){return e.handleSaveDraft()}}}):e._e(),e.publishVisible?t("ReactiveButton",{attrs:{errored:e.form.publishErrored,loading:e.form.publishing,erroredText:"发布失败",loadedText:"发布成功",text:"转为发布"},on:{callback:function(t){return e.handleSavedCallback()},click:function(t){return e.handlePublish()}}}):e._e(),t("ReactiveButton",{attrs:{errored:e.form.saveErrored,erroredText:(e.hasId?"保存":"发布")+"失败",loadedText:(e.hasId?"保存":"发布")+"成功",loading:e.form.saving,text:""+(e.hasId?"保存":"发布")},on:{callback:function(t){return e.handleSavedCallback()},click:function(t){return e.handleSave()}}}),t("a-button",{attrs:{disabled:e.loading},on:{click:function(t){e.modalVisible=!1}}},[e._v("关闭")])]},proxy:!0}],null,!0),model:{value:e.modalVisible,callback:function(t){e.modalVisible=t},expression:"modalVisible"}},[t("div",{staticClass:"card-container"},[t("a-tabs",{attrs:{type:"card"}},[t("a-tab-pane",{key:"normal",attrs:{tab:"常规"}},[t("a-form",{attrs:{"label-col":e.form.labelCol,"wrapper-col":e.form.wrapperCol,labelAlign:"left"}},[t("a-form-item",{attrs:{label:"页面标题"}},[t("a-input",{model:{value:e.form.model.title,callback:function(t){e.$set(e.form.model,"title",t)},expression:"form.model.title"}})],1),t("a-form-item",{attrs:{help:e.fullPath,label:"页面别名"}},[t("a-input",{scopedSlots:e._u([{key:"addonAfter",fn:function(){return[t("a-popconfirm",{attrs:{"cancel-text":"取消","ok-text":"确定",placement:"left",title:"是否确定根据标题重新生成别名？"},on:{confirm:e.handleGenerateSlug}},[t("a-icon",{staticClass:"cursor-pointer",attrs:{type:"sync"}})],1)]},proxy:!0}]),model:{value:e.form.model.slug,callback:function(t){e.$set(e.form.model,"slug",t)},expression:"form.model.slug"}})],1),t("a-form-item",{attrs:{label:"摘要"}},[t("a-input",{attrs:{autoSize:{minRows:5},placeholder:"如不填写，会从页面中自动截取",type:"textarea"},model:{value:e.form.model.summary,callback:function(t){e.$set(e.form.model,"summary",t)},expression:"form.model.summary"}})],1)],1)],1),t("a-tab-pane",{key:"advanced",attrs:{tab:"高级"}},[t("a-form",{attrs:{"label-col":e.form.labelCol,"wrapper-col":e.form.wrapperCol,labelAlign:"left"}},[t("a-form-item",{attrs:{label:"禁止评论"}},[t("a-switch",{model:{value:e.form.model.disallowComment,callback:function(t){e.$set(e.form.model,"disallowComment",t)},expression:"form.model.disallowComment"}})],1),t("a-form-item",{attrs:{label:"发表时间："}},[t("a-date-picker",{attrs:{defaultValue:e.createTimeDefaultValue,format:"YYYY-MM-DD HH:mm:ss",placeholder:"选择页面发表时间",showTime:""},on:{change:e.onCreateTimeSelect,ok:e.onCreateTimeSelect}})],1),t("a-form-item",{attrs:{label:"自定义模板："}},[t("a-select",{model:{value:e.form.model.template,callback:function(t){e.$set(e.form.model,"template",t)},expression:"form.model.template"}},[t("a-select-option",{key:"",attrs:{value:""}},[e._v("无")]),e._l(e.templates,(function(a){return t("a-select-option",{key:a,attrs:{value:a}},[e._v(" "+e._s(a)+" ")])}))],2)],1),t("a-form-item",{attrs:{label:"封面图："}},[t("a-space",{attrs:{direction:"vertical"}},[t("img",{staticClass:"w-1/2 cursor-pointer",staticStyle:{"border-radius":"4px"},attrs:{src:e.form.model.thumbnail||"/images/placeholder.jpg",alt:"Sheet cover thumbnail"},on:{click:function(t){e.attachmentSelectVisible=!0}}}),t("a-input",{attrs:{"allow-clear":"",placeholder:"点击封面图选择图片，或者输入外部链接"},model:{value:e.form.model.thumbnail,callback:function(t){e.$set(e.form.model,"thumbnail",t)},expression:"form.model.thumbnail"}})],1)],1)],1)],1),t("a-tab-pane",{key:"seo",attrs:{tab:"SEO"}},[t("a-form",{attrs:{"label-col":e.form.labelCol,"wrapper-col":e.form.wrapperCol,labelAlign:"left"}},[t("a-form-item",{attrs:{label:"自定义关键词"}},[t("a-input",{attrs:{autoSize:{minRows:5},placeholder:"多个关键词以英文逗号隔开",type:"textarea"},model:{value:e.form.model.metaKeywords,callback:function(t){e.$set(e.form.model,"metaKeywords",t)},expression:"form.model.metaKeywords"}})],1),t("a-form-item",{attrs:{label:"自定义描述"}},[t("a-input",{attrs:{autoSize:{minRows:5},placeholder:"如不填写，会从页面中自动截取",type:"textarea"},model:{value:e.form.model.metaDescription,callback:function(t){e.$set(e.form.model,"metaDescription",t)},expression:"form.model.metaDescription"}})],1)],1)],1),t("a-tab-pane",{key:"meta",attrs:{tab:"元数据"}},[t("MetaEditor",{attrs:{metas:e.form.model.metas,targetId:e.form.model.id,target:"sheet"},on:{"update:metas":function(t){return e.$set(e.form.model,"metas",t)}}})],1)],1)],1),t("AttachmentSelectModal",{attrs:{multiSelect:!1,visible:e.attachmentSelectVisible},on:{"update:visible":function(t){e.attachmentSelectVisible=t},confirm:e.handleSelectSheetThumbnail}})],1)},r=[],i=a(8641),s=a(83428),n=a(64203),l=a(80981),d=a.n(l),h=a(20629),m=a(32422),c=a(80068),u={name:"SheetSettingModal",mixins:[s.jB,s.KT],components:{MetaEditor:i.Z},props:{visible:{type:Boolean,default:!1},loading:{type:Boolean,default:!1},sheet:{type:Object,default:()=>({})},savedCallback:{type:Function,default:null}},data(){return{sheetStatuses:m.Zi,form:{model:{},saving:!1,saveErrored:!1,draftSaving:!1,draftSaveErrored:!1,publishing:!1,publishErrored:!1,labelCol:{sm:{span:4},xs:{span:24}},wrapperCol:{sm:{span:20},xs:{span:24}}},templates:[],attachmentSelectVisible:!1}},computed:{...(0,h.Se)(["options"]),modalVisible:{get(){return this.visible},set(e){this.$emit("update:visible",e)}},modalTitle(){return this.form.model.id?"页面设置":"页面发布"},createTimeDefaultValue(){if(this.form.model.createTime){const e=new Date(this.form.model.createTime);return(0,n._)(e,"YYYY-MM-DD HH:mm:ss")}return(0,n._)(new Date,"YYYY-MM-DD HH:mm:ss")},fullPath(){const{sheet_permalink_type:e,blog_url:t,sheet_prefix:a,path_suffix:o=""}=this.options,{slug:r="{slug}"}=this.form.model;switch(e){case"SECONDARY":return`${t}/${a}/${r}${o}`;case"ROOT":return`${t}/${r}${o}`;default:return""}},hasId(){return!!this.form.model.id},draftSaveVisible(){const{draftSaving:e,publishing:t}=this.form;return(this.form.model.status!==m.Zi.DRAFT.value||!this.hasId||e)&&!t},publishVisible(){const{draftSaving:e,publishing:t}=this.form;return(this.form.model.status===m.Zi.DRAFT.value&&this.hasId||t)&&!e}},watch:{modalVisible(e){e&&(this.form.model=Object.assign({},this.sheet),this.form.model.slug||this.form.model.id||this.handleGenerateSlug())},sheet:{deep:!0,handler(e){this.form.model=Object.assign({},e)}}},created(){this.handleListCustomTemplates()},methods:{async handleCreateOrUpdate(){if(!this.form.model.title)throw this.$notification["error"]({message:"提示",description:"页面标题不能为空！"}),new Error("文章标题不能为空！");this.form.model.keepRaw=!0;try{this.hasId?await c.Z.sheet.update(this.form.model.id,this.form.model):await c.Z.sheet.create(this.form.model)}catch(e){throw this.$log.error(e),new Error(e)}},async handleSave(){try{this.form.saving=!0;const{status:e}=this.form.model;e||(this.form.model.status=this.sheetStatuses.PUBLISHED.value),await this.handleCreateOrUpdate()}catch(e){this.form.saveErrored=!0,this.$log.error("Failed to save sheet",e)}finally{setTimeout((()=>{this.form.saving=!1}),400)}},async handlePublish(){try{this.form.publishing=!0,this.form.model.status=this.sheetStatuses.PUBLISHED.value,await this.handleCreateOrUpdate()}catch(e){this.form.publishErrored=!0,this.$log.error("Failed to publish sheet",e)}finally{setTimeout((()=>{this.form.publishing=!1}),400)}},async handleSaveDraft(){try{this.form.draftSaving=!0,this.form.model.status=this.sheetStatuses.DRAFT.value,await this.handleCreateOrUpdate()}catch(e){this.form.draftSaveErrored=!0,this.$log.error("Failed to save draft sheet",e)}finally{setTimeout((()=>{this.form.draftSaving=!1}),400)}},handleSavedCallback(){this.form.saveErrored||this.form.draftSaveErrored||this.form.publishErrored?(this.form.saveErrored=!1,this.form.draftSaveErrored=!1,this.form.publishErrored=!1):this.savedCallback&&this.savedCallback()},async handleListCustomTemplates(){try{const e=await c.Z.theme.listCustomSheetTemplates();this.templates=e.data}catch(e){this.$log.error(e)}},onCreateTimeSelect(e){this.form.model.createTime=e.valueOf()},handleGenerateSlug(){if(this.form.model.title&&d().isSupported()){let e="";const t=d().parse(this.form.model.title.replace(/\s+/g,"").toLowerCase());let a;t.forEach((t=>{if(2===t.type){const o=t.target?t.target.toLowerCase():"";e+=e&&!/\n|\s/.test(a.target)?"-"+o:o}else e+=(a&&2===a.type?"-":"")+t.target;a=t})),this.$set(this.form.model,"slug",e)}},handleSelectSheetThumbnail({raw:e}){e.length&&(this.form.model.thumbnail=e[0].path),this.attachmentSelectVisible=!1},onClosed(){this.$emit("onClose"),this.$emit("onUpdate",this.form.model)}}},f=u,p=a(1001),g=(0,p.Z)(f,o,r,!1,null,null,null),b=g.exports},91296:function(e,t,a){var o="Expected a function",r=NaN,i="[object Symbol]",s=/^\s+|\s+$/g,n=/^[-+]0x[0-9a-f]+$/i,l=/^0b[01]+$/i,d=/^0o[0-7]+$/i,h=parseInt,m="object"==typeof a.g&&a.g&&a.g.Object===Object&&a.g,c="object"==typeof self&&self&&self.Object===Object&&self,u=m||c||Function("return this")(),f=Object.prototype,p=f.toString,g=Math.max,b=Math.min,v=function(){return u.Date.now()};function S(e,t,a){var r,i,s,n,l,d,h=0,m=!1,c=!1,u=!0;if("function"!=typeof e)throw new TypeError(o);function f(t){var a=r,o=i;return r=i=void 0,h=t,n=e.apply(o,a),n}function p(e){return h=e,l=setTimeout(C,t),m?f(e):n}function S(e){var a=e-d,o=e-h,r=t-a;return c?b(r,s-o):r}function w(e){var a=e-d,o=e-h;return void 0===d||a>=t||a<0||c&&o>=s}function C(){var e=v();if(w(e))return k(e);l=setTimeout(C,S(e))}function k(e){return l=void 0,u&&r?f(e):(r=i=void 0,n)}function x(){void 0!==l&&clearTimeout(l),h=0,r=d=i=l=void 0}function $(){return void 0===l?n:k(v())}function D(){var e=v(),a=w(e);if(r=arguments,i=this,d=e,a){if(void 0===l)return p(d);if(c)return l=setTimeout(C,t),f(d)}return void 0===l&&(l=setTimeout(C,t)),n}return t=T(t)||0,y(a)&&(m=!!a.leading,c="maxWait"in a,s=c?g(T(a.maxWait)||0,t):s,u="trailing"in a?!!a.trailing:u),D.cancel=x,D.flush=$,D}function y(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function w(e){return!!e&&"object"==typeof e}function C(e){return"symbol"==typeof e||w(e)&&p.call(e)==i}function T(e){if("number"==typeof e)return e;if(C(e))return r;if(y(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=y(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(s,"");var a=l.test(e);return a||d.test(e)?h(e.slice(2),a?2:8):n.test(e)?r:+e}e.exports=S}}]);